<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yunos.tv.appupgrade.dal.dao.UpgradeVersionPrepublishUuidDAO">


	<select id="countByPrepublishId" resultType="int" parameterType="long">
		SELECT 
			COUNT(1)
		FROM
			`upg_version_prepublish_uuid`
		WHERE
			`prepublish_id` = #{prepublishId}
	</select>

	<select id="getByPrepublishIdAndUUID" resultType="UpgradeVersionPrepublishUuidDo" parameterType="UpgradeVersionPrepublishUuidDo">
		SELECT
			`id`,`prepublish_id`,`uuid`,`counter`
		FROM
			`upg_version_prepublish_uuid`
		WHERE			
			`prepublish_id` = #{prepublishId} AND
			`uuid` = #{uuid}
		ORDER BY `id` DESC
		LIMIT 1				
	</select>		

	<update id="incrCounter" parameterType="UpgradeVersionPrepublishUuidDo" flushCache="true">
		UPDATE 
			`upg_version_prepublish_uuid`
		<set>
			<if test="incr != null">
				`counter` = `counter` + #{incr},
			</if>
			`gmt_modify` = now()	
		</set>
		WHERE
			`id` = #{id}
	</update>
	
	<insert id="add" parameterType="UpgradeVersionPrepublishUuidDo" keyProperty="id" useGeneratedKeys="true">
		INSERT INTO 
			`upg_version_prepublish_uuid`
		(
			`prepublish_id`,
			`uuid`,
			`counter`,
			`gmt_create`
		) VALUES (
			#{prepublishId},
			#{uuid},
			#{counter},
			now()
		)
	</insert>
</mapper>